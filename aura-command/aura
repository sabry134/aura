#!/bin/sh

START_TIME_FILE="$HOME/.aura_start_time"  # File to store the start time
RUNNING_PID_FILE="$HOME/.aura_running_pid"  # File to store the running process ID

error() {
    echo "Error: $1" >&2
    exit 1
}

cleanup() {
    if [ -f "$START_TIME_FILE" ]; then
        rm "$START_TIME_FILE"  # Remove the start time file on exit
        echo "Bot stopped, timer reset."
    fi

    if [ -f "$RUNNING_PID_FILE" ]; then
        rm "$RUNNING_PID_FILE"  # Remove the running PID file on exit
    fi
}

uptime() {
    if [ ! -f "$START_TIME_FILE" ]; then
        echo "Error: Bot has not started yet."
        exit 1
    fi

    START_TIME=$(cat "$START_TIME_FILE")  # Read the start time from the file
    CURRENT_TIME=$(date +%s)
    DIFF=$((CURRENT_TIME - START_TIME))

    # Convert seconds into days, hours, minutes, and seconds
    DAYS=$((DIFF / 86400))
    HOURS=$(( (DIFF % 86400) / 3600 ))
    MINUTES=$(( (DIFF % 3600) / 60 ))
    SECONDS=$((DIFF % 60))

    # Display uptime in a readable format
    echo "Bot uptime: ${DAYS}d ${HOURS}h ${MINUTES}m ${SECONDS}s"
}

restart() {
    if [ -f "$RUNNING_PID_FILE" ]; then
        PID=$(cat "$RUNNING_PID_FILE")
        if kill -0 "$PID" > /dev/null 2>&1; then
            echo "Stopping the bot..."
            kill "$PID"  # Stop the running process
            wait "$PID"  # Ensure the process stops completely
            echo "Bot stopped."
        fi
        rm "$RUNNING_PID_FILE"  # Remove the running PID file
    fi

    # Restart the bot
    echo "Restarting the bot..."

    # Check if pm2 is managing the process
    if command -v pm2 >/dev/null 2>&1; then
        # Gracefully restart using pm2
        pm2 restart aura-server.js || error "Failed to restart bot with pm2."
        echo "Bot restarted using pm2."
    else
        echo "Running 'server.js' normally..."
        node "$2" &
        echo "$!" > "$RUNNING_PID_FILE"  # Store the process ID
    fi
}

case "$1" in
    help)
        echo -e "\n✨ Aura CLI - Help Menu ✨\n"
        echo -e "Here are the available commands for Aura CLI:\n"

        echo -e "🔹 \033[1mrun [file.js] [-b]\033[0m"
        echo -e "   - Runs the specified file. Optionally, use the '-b' flag to run it in the background using pm2.\n"

        echo -e "🔹 \033[1mrestart [file.js] [-b]\033[0m"
        echo -e "   - Restarts the bot. It will first stop the current process and then re-run the specified file.\n"

        echo -e "🔹 \033[1muptime\033[0m"
        echo -e "   - Shows the uptime of the bot.\n"

        echo -e "ℹ️ For more information on each command, you can use the 'help' option next to the command.\n"

        echo -e "Example usage:\n"
        echo -e "  aura run server.js\n  aura restart server.js\n  aura uptime\n"
        ;;
    run)
        if [ "$#" -lt 2 ]; then
            error "Usage: aura run [file].js [-b]"
        fi

        FILE=$2
        BACKGROUND=0

        if [ "$3" = "-b" ]; then
            BACKGROUND=1
        fi

        if [ ! -f "$FILE" ]; then
            error "File '$FILE' not found."
        fi

        # Save the start time to the file
        date +%s > "$START_TIME_FILE"

        # Ensure cleanup happens on script exit (when the bot is stopped or aborted)
        trap cleanup EXIT

        if [ "$BACKGROUND" -eq 1 ]; then
            command -v pm2 >/dev/null 2>&1 || error "pm2 is required but not installed. Install it with 'npm install -g pm2'"
            echo "Running '$FILE' in background using pm2..."

            # Check if the process is already running on pm2
            if pm2 list | grep -q "$FILE"; then
                echo "Bot is already running in the background using pm2."
            else
                pm2 start "$FILE" --name "aura-$FILE"
            fi

            # Store the pm2 process ID
            PM2_PID=$(pm2 pid "$FILE")
            echo "$PM2_PID" > "$RUNNING_PID_FILE"
        else
            echo "Running '$FILE' normally..."
            node "$FILE" &
            echo "$!" > "$RUNNING_PID_FILE"  # Store the process ID
        fi
        ;;
    uptime)
        uptime
        ;;
    restart)
        restart "$@"  # Pass all arguments to the restart function
        ;;
    *)
        echo "Unknown command: $1"
        exit 1
        ;;
esac
